"use strict";function oAuth2ImplicitFlow(e,t,n,r,o,a){var l="oauth_state",i=new URITemplate(e+"?response_type=token&client_id={client_id}&redirect_uri={redirect_uri}&state={state}");return{prepareAuthzRequest:function(e){var u=new Uint8Array(16);a.getRandomValues(u),u=r.encode(u),o.setItem(l,u);var c=i.expand({client_id:t,redirect_uri:n+e,state:u});return c},processAuthzResponse:function(e){var t=function(e){return{success:!1,error:e}};if(!e.state)return t("invalid response");var n=o.getItem(l);return o.removeItem(l),n&&n===e.state?e.error?t(e.error):e.access_token?{success:!0,accessToken:e.access_token,expiresIn:e.expires_in}:t("invalid response"):t("missing or invalid state")}}}!function(){var e=angular.module("cloudPlayer",["ngRoute","cloudPlayer.controllers","cloudPlayer.filters","cloudPlayer.directives","cloudPlayer.oauth2","cfp.hotkeys"]),t={authzEndpoint:"https://meocloud.pt/oauth2/authorize",apiBaseAddress:"https://publicapi.meocloud.pt/1",root:"meocloud",clientIds:{dev:"4722fde2-2f99-4118-9373-3270c572d003",pub:"6abdf380-083a-453a-9e36-1b1528ab8255"},name:"meocloud",displayName:"MEO Cloud",shouldReadTags:!1};e.constant("cloudConfig",t),e.config(["$locationProvider","$routeProvider",function(e,t){e.hashPrefix("!"),t.when("/",{controller:"HomeCtrl",controllerAs:"home",templateUrl:"views/home.html"}).when("/oauth/:mode",{controller:"OAuthCtrl",controllerAs:"oauth",templateUrl:"views/oauth.html"}).when("/player",{controller:"PlayerCtrl",controllerAs:"player",templateUrl:"views/player.html"}).otherwise({redirectTo:"/"})}]),e.run(["$http","$httpParamSerializerJQLike",function(e,t){e.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded",e.defaults.transformRequest.unshift(t)}])}(),angular.module("cloudPlayer.controllers",["cloudPlayer.oauth2","cloudPlayer.services"]).controller("HomeCtrl",["$window","$location","cloudConfig","fileManager",function(e,t,n,r){this.cloudName=n.displayName,t.hash()&&t.path("/oauth/callback");var o=new URI(t.absUrl());return o.query()?(o.hash(o.query()),o.query(""),void(e.location.href=o.toString())):r.client.hasToken()?void t.path("/player"):void 0}]).controller("OAuthCtrl",["$window","$location","$routeParams","oAuth2ImplicitFlow","cloudClient",function(e,t,n,r,o){if("authorize"===n.mode)e.location.href=r.prepareAuthzRequest("");else if("callback"===n.mode){var a=r.processAuthzResponse(URI.parseQuery(t.hash()));a.success?(o.setToken(a.accessToken),t.url("/player")):(this.hasError=!0,this.error=a.error)}}]).controller("PlayerCtrl",["$location","cloudConfig","fileManager",function(e,t,n){var r=function(e){return{artist:"Artist",title:"Title",album:"Album",year:"year",url:e}},o=this;return o.showFileInfo=t.shouldReadTags,o.currentFile=r(),o.canPlay=!1,o.canDelete=!1,n.client.hasToken()?(o.next=function(){return o.canDelete=!1,n.getRandomFileData().then(function(e){o.currentFile=r(e.url),o.canDelete=!0,t.shouldReadTags&&e.readTags&&e.readTags().then(function(e){o.currentFile.artist=e.artist||"N/A",o.currentFile.title=e.title||"N/A",o.currentFile.album=e.album||"N/A",o.currentFile.year=e.year||"N/A"})})},o.deleteCurrent=function(){o.canPlay=!1,o.canDelete=!1,o.currentFile=r,n.deleteCurrentFile().then(function(){n.hasFiles()&&o.next().then(function(){o.canPlay=!0})})},void n.update().then(function(){n.hasFiles()&&o.next().then(function(){o.canPlay=!0})})):void e.path("/")}]),angular.module("cloudPlayer.directives",[]).directive("cpConfirmClick",["$window",function(e){return{restrict:"A",scope:{clickAction:"&cpConfirmClick"},link:function(t,n,r){n.bind("click",function(){e.confirm("Are you sure?")&&t.clickAction()})}}}]).directive("cpBind",[function(){return{restrict:"A",scope:{eventName:"@cpBind",handler:"&cpBindHandler"},link:function(e,t,n){t.bind(e.eventName,e.handler)}}}]),angular.module("cloudPlayer.filters",[]).filter("trustedUrl",["$sce",function(e){return function(t){return e.trustAsResourceUrl(t)}}]),angular.module("cloudPlayer.services",[]).factory("cloudClient",["$window","$http","cloudConfig",function(e,t,n){var r=n.adjustApiPath||function(e){return e},o=n.apiBaseAddress+r("/Delta"),a=new URITemplate(n.apiBaseAddress+r("/Media/")+n.root+"{+path}"),l=n.apiBaseAddress+r("/Fileops/Delete"),i={Authorization:function(){return"Bearer "+d()}},u=e.localStorage,c=n.name+"_oauth_token",s=null,d=function(){return s=s||u.getItem(c)},f=function(n,r){return e.console.log("DELTA %s",n),t.post(o,{cursor:n},{headers:i}).then(function(e){var t=e.data,n=[],o=[];t.entries.forEach(function(e){var t=e[1];null!==t?(t.path=e[0],n.push(e[1])):o.push(e[0])});var a=r(n,o,t.cursor);return t.has_more&&(a=a.then(function(){return f(t.cursor,r)})),a})};return{hasToken:function(){return null!==d()},setToken:function(e){u.setItem(c,e),s=null},delta:f,getFileUrl:function(e){return t({method:"POST",url:a.expand({path:e}),headers:i}).then(function(e){return e.data})},deleteFile:function(e){return t.post(l,{path:e,root:n.root},{headers:i})}}}]),angular.module("cloudPlayer.services").factory("fileManager",["$window","$q","cloudClient","cloudConfig",function(e,t,n,r){var o=null,a=0,l=null,i=r.name+"_last_cursor",u="files",c=function(t){if(null!==l)return void t();var n=e.indexedDB.open(r.name,1);n.onsuccess=function(n){l=n.target.result,l.onerror=function(t){e.console.error("Database error: "+t.target.errorCode)},t()},n.onupgradeneeded=function(t){var n=t.target.result;e.console.log("Creating files object store"),n.createObjectStore(u,{keyPath:"path"})}},s=function(t,n){t.mime_type.startsWith("audio/mpeg")||"audio/wav"===t.mime_type||t.path.endsWith(".mp3")?n.put({path:t.path,tags:null}).onsuccess=function(){e.console.info("ADD %s",t.path)}:e.console.log("IGNORE %s due to mime-type %s",t.path,t.mime_type)},d=function(t,n){n.get(t.path).onsuccess=function(r){r.target.result&&(n["delete"](t.path).onsuccess=function(){e.console.info("REMOVE %s",t.path)})}},f=function(t,n){e.console.log("Paths were deleted:"),e.console.log(t),n.openCursor().onsuccess=function(n){var r=n.target.result;r&&(t.some(function(e){return r.key.startsWith(e)})?r["delete"]().onsuccess=function(){e.console.info("REMOVE %s",r.key),r["continue"]()}:r["continue"]())}},h=function(){var e=t.defer(),n=Math.floor(Math.random()*a);return l.transaction(u).objectStore(u).openCursor().onsuccess=function(t){var r=t.target.result;n>0?(r.advance(n),n=-1):e.resolve(r.value)},e.promise},p=function(n,r){var o=t.defer();return n.tags?(o.resolve(n.tags),o.promise):(jsmediatags.read(r,{onSuccess:function(t){var r={artist:t.tags.artist,title:t.tags.title,album:t.tags.album,year:t.tags.year};(r.artist||r.title)&&(n.tags=r,l.transaction(u,"readwrite").objectStore(u).put(n).onsuccess=function(){e.console.debug("Updated tags for %s",n.path)}),o.resolve(r)},onError:function(t){e.console.warn("Cannot read tags for %s",n.path),e.console.warn(t),o.resolve({})}}),o.promise)},m=function(n,r,o){var a=t.defer(),c=l.transaction(u,"readwrite");c.oncomplete=function(){e.localStorage.setItem(i,o),a.resolve()},c.onerror=function(){a.reject()};var h=c.objectStore(u);return r.length>0&&f(r,h),n.forEach(function(e){e.is_dir?d(e,h):s(e,h)}),a.promise},g=function(){return t(function(t){c(function(){e.console.log("UPDATE STARTED"),n.delta(e.localStorage.getItem(i),m).then(function(){l.transaction(u).objectStore(u).count().onsuccess=function(n){a=n.target.result,e.console.info("UPDATE COMPLETED Total files: %d",a),t()}})})})};return{client:n,hasFiles:function(){return 0!==a},update:g,getRandomFileData:function(){return h().then(function(e){return o=e,n.getFileUrl(e.path).then(function(t){var n={url:t.url};return r.shouldReadTags&&(n.readTags=function(){return p(e,t.url)}),n})})},deleteCurrentFile:function(){return n.deleteFile(o.path).then(function(){return o=null,g()})}}}]),angular.module("cloudPlayer.oauth2",[]).value("base64url",{encode:function(e){return btoa(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}}).factory("oAuth2ImplicitFlow",["$window","cloudConfig","base64url",function(e,t,n){return oAuth2ImplicitFlow(t.authzEndpoint,"localhost"===e.location.hostname||"127.0.0.1"===e.location.hostname?t.clientIds.dev:t.clientIds.pub,e.location.origin+e.location.pathname,n,e.sessionStorage,e.crypto)}]);
//# sourceMappingURL=bundle.js.map
